- name: install and configure The Node Application
  hosts: API

  vars:
      - NODE_VERSION: v18.3.0
      - REPO_NAME: ainfras

  tasks:
      - name: clone The repo
        ansible.builtin.git:
           force: yes
           repo: git@github.com:noatheo/ainfras.git
           dest: /home/dep/{{REPO_NAME}}
            
            
     
            
            
      - name: Excute NVM Installation Script.
        become_user: dep
        ansible.builtin.shell: bash envadd.sh
        
      - name: Reprocess Environment Variables.
        become_user: API_SERVESES
        ansible.builtin.shell: |
          source ~/.bashrc
          source ~/.profile
        args:
            executable: /bin/bash
            
       
      - name: Run the API service
        ansible.builtin.command: "/home/dep/.nvm/versions/node/{{NODE_VERSION}}/bin/pm2 start npm -- start"
        environment:
            PATH: "{{ ansible_env.PATH }}:/home/dep/.nvm/versions/node/{{NODE_VERSION}}/bin"
        args:
            chdir: /home/dep/owk-api-gateway
            
            
      - name: Installing Node dependencies
        ansible.builtin.command: /home/dep/.nvm/versions/node/{{NODE_VERSION}}/bin/npm i
        environment:
            PATH: "{{ ansible_env.PATH }}:/home/dep/.nvm/versions/node/{{NODE_VERSION}}/bin"
        args:
            chdir: /home/dep/{{REPO_NAME}}
      
      
      
